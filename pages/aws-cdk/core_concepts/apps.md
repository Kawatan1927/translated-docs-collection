# AWS CDK アプリ

AWS Cloud Development Kit (AWS CDK) のアプリケーション、またはアプリとは、1 つ以上の CDK スタックの集まりを指します。スタックは、1 つ以上のコンストラクトの集合であり、AWS リソースとそのプロパティを定義します。したがって、スタックとコンストラクトの全体のグループが CDK アプリとなります。

---

## CDK アプリの作成方法

CDK アプリは、プロジェクトのアプリケーションファイル内でアプリインスタンスを定義することで作成します。これを行うには、AWS コンストラクトライブラリから App コンストラクトをインポートして使用します。App コンストラクトは初期化引数を必要とせず、ルートとして使用できる唯一のコンストラクトです。

App および Stack クラスは AWS コンストラクトライブラリの中で特別な位置づけとなっており、他のコンストラクトとは異なり、単独で AWS リソースを構成しません。代わりに、他のコンストラクトにコンテキストを提供するために使用されます。AWS リソースを表すすべてのコンストラクトは、直接または間接的に Stack コンストラクトのスコープ内に定義される必要があります。Stack コンストラクトは App コンストラクトのスコープ内で定義されます。

その後、アプリはシンセサイズ（合成）され、スタックのための AWS CloudFormation テンプレートが生成されます。以下はその例です。

```javascript
const app = new App();
new MyFirstStack(app, 'hello-cdk');
app.synth();
```

---

## スタック間のリソース参照と依存関係

同一アプリ内のスタックは、互いのリソースやプロパティを容易に参照できます。AWS CDK はスタック間の依存関係を自動的に推論するため、正しい順序でのデプロイが可能です。また、1 つの `cdk deploy` コマンドで、アプリ内の任意またはすべてのスタックをデプロイできます。

---

## コンストラクトツリー

コンストラクトは、各コンストラクトに渡される `scope` 引数を使用して、他のコンストラクト内に定義されます。この `scope` は App クラスをルートとするコンストラクトツリーを形成します。

- **ルート:**  
  ツリーのルートは App インスタンスです。

- **階層構造:**  
  App 内に 1 つ以上のスタックをインスタンス化し、各スタック内でさらにコンストラクトをインスタンス化します。これらのコンストラクトは、リソースや他のコンストラクトをさらに内包する場合もあります。

コンストラクトは必ず他のコンストラクトのスコープ内で明示的に定義され、その結果、コンストラクト間に親子関係が生まれます。通常、`this`（Python では `self`）をスコープとして渡し、新たに生成するコンストラクトが現在のコンストラクトの子であることを示します。このパターンでは、ユーザーは Construct を継承し、そのコンストラクタ内で必要なコンストラクトをインスタンス化します。

スコープを明示的に渡すことで、各コンストラクトは自身をツリーに追加し、その動作は Construct 基底クラスにより一元管理されます。この仕組みは AWS CDK がサポートするすべての言語で同様に動作し、追加のカスタマイズは不要です。

> **重要:**  
> 技術的には、コンストラクトを生成する際に `this` 以外のスコープを渡すことも可能です。しかし、その場合、他のスコープ内で使用する ID の一意性を保証することが難しくなり、コードの理解、保守、再利用が困難になります。そのため、一般的なコンストラクトツリーの構造を使用することを推奨します。

---

## コンストラクトツリーと CloudFormation の一意な ID

AWS CDK は、ツリーのルートから各子コンストラクトまでのすべてのコンストラクトの ID を組み合わせることで、AWS CloudFormation が要求する一意の ID を生成します。このため、コンストラクトの ID は、ネイティブな AWS CloudFormation の場合のようにスタック全体で一意である必要はなく、そのスコープ内で一意であれば十分です。ただし、コンストラクトを別のスコープに移動すると生成されるスタック一意の ID が変更され、AWS CloudFormation では同一リソースとはみなされなくなります。

---

## ノード属性とコンストラクトツリーの操作

各コンストラクトは、ツリー内のそのコンストラクトを表すノードへの参照である `node` 属性を持っています。`node` は、以下の情報を提供します。

- **node.children:**  
  コンストラクトの直接の子要素

- **node.id:**  
  スコープ内でのコンストラクトの識別子

- **node.path:**  
  ルートからコンストラクトまでの完全なパス（各親の ID を含む）

- **node.root:**  
  コンストラクトツリーのルート（アプリ）

- **node.scope:**  
  コンストラクトのスコープ（親）または、ルートの場合は未定義

- **node.scopes:**  
  ルートまでのすべての親スコープ

- **node.uniqueId:**  
  ツリー内でのこのコンストラクトの一意な英数字識別子（通常、node.path とハッシュから生成）

コンストラクトツリーは、最終的な AWS CloudFormation テンプレートにリソースが合成される際の暗黙の順序を定義します。あるリソースが他のリソースより先に作成される必要がある場合、AWS CloudFormation または AWS コンストラクトライブラリが依存関係を推論し、正しい順序でリソースが作成されるようにします。

また、`node.addDependency()` を使用することで、2 つのノード間に明示的な依存関係を追加することも可能です。詳細は AWS CDK API リファレンス内の [Dependencies](#) をご参照ください。

さらに、AWS CDK はコンストラクトツリー内のすべてのノードを巡回し、各ノードに対して操作を実行するシンプルな方法を提供しています。詳細は [Aspects and the AWS CDK](#) をご参照ください。

---